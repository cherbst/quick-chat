jQuery.fn.quick_chat_insert_at_caret=function(t){return this.each(function(){if(document.selection)this.focus(),sel=document.selection.createRange(),sel.text=t,this.focus();else if(this.selectionStart||"0"==this.selectionStart){var a=this.selectionStart,e=this.selectionEnd,i=this.scrollTop;this.value=this.value.substring(0,a)+t+this.value.substring(e,this.value.length),this.focus(),this.selectionStart=a+t.length,this.selectionEnd=a+t.length,this.scrollTop=i}else this.value+=t,this.focus()})};var quick_chat=jQuery.extend(quick_chat||{},{last_timestamp:0,rooms:[],private_queue:{},private_current:{},private_count:0,audio_support:0,play_audio:0,audio_element:document.createElement("audio"),update_users_limit:Math.floor(quick_chat.inactivity_timeout/quick_chat.timeout_refresh_users),update_users_counter:0,private_queue_name:"quick_chat_private_queue_"+quick_chat.user_id,random_string:function(t){for(var a,e=0,i="";t>e;)a=Math.floor(100*Math.random())%94+33,a>=33&&47>=a||a>=58&&64>=a||a>=91&&96>=a||a>=123&&126>=a||(e++,i+=String.fromCharCode(a));return"quick_chat_"+i},is_user_inactive:function(){return quick_chat.update_users_counter==quick_chat.update_users_limit&&0!=quick_chat.user_status?!0:!1},is_private_eq:function(t,a){return t.private_from==a.private_from&&t.private_to==a.private_to||t.private_to==a.private_from&&t.private_from==a.private_to?!0:!1},spawn_private_chat:function(t,a,e){var i={};i.room_name=t,i.userlist_position="top",i.scroll_enable=1,i.avatars=1,i.him=a,"o"==e?i.state="o":i.state="m",quick_chat.data[t]=i;var c='<div class="quick-chat-container quick-chat-container-private" data-quick-chat-id="'+t+'"><div class="quick-chat-container-private-titlebar"><div class="quick-chat-container-private-title">'+quick_chat.i18n.private_title_s+'</div><div class="quick-chat-container-private-close"><a href="" title="'+quick_chat.i18n.private_close_s+'">x</a></div><div class="quick-chat-container-private-minimize-restore"><a href="" title="';c+="o"==e?quick_chat.i18n.private_minimize_s:quick_chat.i18n.private_restore_s,c+='">'+("o"==e?"-":"o")+'</a></div></div><div class="quick-chat-users-container quick-chat-users-container-top"></div><div class="quick-chat-history-container" style="height: 300px;"></div>',0==quick_chat.user_status&&(c+='<div class="quick-chat-links"><div class="quick-chat-left-link quick-chat-transcript-link"><a title="'+quick_chat.i18n.fetch_transcript_s+'" href="">'+quick_chat.i18n.transcript_s+"</a></div></div>"),c+='<div class="quick-chat-alias-container"><input class="quick-chat-alias" type="text" autocomplete="off" maxlength="20" value="'+quick_chat.user_name+'" readonly="readonly" /></div><textarea class="quick-chat-message"></textarea></div>',jQuery("body").append(c);var u=jQuery('div[data-quick-chat-id="'+t+'"]');quick_chat.private_right_position(u),quick_chat.private_bottom_position(u,e)},private_right_position:function(t){var a=t.outerWidth(!0)*quick_chat.private_count;quick_chat.private_count++,t.css("right",a)},private_bottom_position:function(t,a){"o"==a?jQuery(t).animate({bottom:0},500):"m"==a&&jQuery(t).animate({bottom:-(jQuery(t).outerHeight(!0)-jQuery(t).find("div.quick-chat-history-container").position().top)},500)},update_private_cookie:function(t,a){jQuery.cookie(t,jQuery.toJSON(a),{path:quick_chat.cookiepath,domain:quick_chat.cookie_domain})},preg_quote:function(t){var a=new RegExp("[.*+?|()\\[\\]{}\\\\]","g");return t.replace(a,"\\$&")},stripslashes:function(t){return t=t.replace(/\\'/g,"'"),t=t.replace(/\\"/g,'"'),t=t.replace(/\\\\/g,"\\"),t=t.replace(/\\0/g,"\x00")},flag_html:function(t){return null!=t.c&&null!=t.m?' <img class="quick-chat-flags" title="'+t.m+'" src="'+quick_chat.quick_flag_url+"/"+t.c+'.gif" />':""},update_rooms:function(){quick_chat.rooms=[];for(var t in quick_chat.data)-1==jQuery.inArray(quick_chat.data[t].room_name,quick_chat.rooms)&&quick_chat.rooms.push(quick_chat.data[t].room_name)},update_sound_state:function(){0==quick_chat.play_audio?jQuery("div.quick-chat-sound-link a").css("text-decoration","line-through"):jQuery("div.quick-chat-sound-link a").css("text-decoration","none")},user_status_class:function(t){var a="";return 0==t?a="quick-chat-admin":1==t?a="quick-chat-loggedin":2==t&&(a="quick-chat-guest"),a},is_private_allowed:function(t){return 0==t||1==t&&1==quick_chat.loggedin_initiate_private||2==t&&1==quick_chat.guests_initiate_private?!0:!1},single_message_html:function(t,a,e){if(0==e)var i=quick_chat.stripslashes(t.alias),c=quick_chat.user_status_class(t.status);else 1==e&&(i=quick_chat.i18n.notice_s,c="quick-chat-notice");var u=quick_chat.stripslashes(t.message);for(var r in quick_chat.smilies){var s='<div class="quick-chat-smile quick-chat-smile-'+quick_chat.smilies[r]+'" title="'+r+'"></div>';u=u.replace(new RegExp(quick_chat.preg_quote(r),"g"),s)}var _='<div class="quick-chat-history-message-alias-container '+c+'"><div class="quick-chat-history-header">';return 1==a&&0!=t.avatar&&(_+=quick_chat.stripslashes(t.avatar)),_+='<div class="quick-chat-history-alias">',_+=i==quick_chat.user_name||1==e||1==quick_chat.no_participation?i:'<a href="" title="'+quick_chat.i18n.reply_to_s.replace("%s",i)+'">'+i+"</a>",_+="</div>",_+='<div class="quick-chat-history-timestring">'+t.timestring+'</div></div><div class="quick-chat-history-message">'+u+"</div>",0==quick_chat.user_status&&(_+='<div class="quick-chat-history-links">'),0==quick_chat.user_status&&0==e&&(_+='<input class="quick-chat-to-delete-boxes" type="checkbox" name="quick-chat-to-delete[]" value="'+t.id+'" />'),0==quick_chat.user_status&&(_+="</div>"),_+="</div>"},check_username:function(t,a,e){"undefined"!=typeof quick_chat.data[t].username_timeout&&clearTimeout(quick_chat.data[t].username_timeout),quick_chat.data[t].username_timeout=setTimeout(function(){jQuery.ajax({type:"POST",url:quick_chat.ajaxurl,data:{action:"quick-chat-ajax-username-check",username_check:a},cache:!1,dataType:"json",success:function(t){0==quick_chat.no_participation&&1==t.no_participation&&location.reload(!0),jQuery(e).html(""),1==t.username_invalid?(jQuery(e).addClass("quick-chat-error"),jQuery(e).html(quick_chat.i18n.username_invalid_s)):1==t.username_bad_words?(jQuery(e).addClass("quick-chat-error"),jQuery(e).html(quick_chat.i18n.username_bad_words_s)):1==t.username_exists?(jQuery(e).addClass("quick-chat-error"),jQuery(e).html(quick_chat.i18n.username_exists_s)):1==t.username_blocked?(jQuery(e).addClass("quick-chat-error"),jQuery(e).html(quick_chat.i18n.username_blocked_s)):(0==t.username_exists||0==t.username_blocked||0==t.username_invalid)&&(jQuery(e).html(""),quick_chat.user_name=t.username,jQuery("input.quick-chat-alias").val(t.username))},beforeSend:function(){jQuery(e).html(""),jQuery(e).removeClass("quick-chat-error"),jQuery(e).html(quick_chat.i18n.username_check_wait_s)}}),delete quick_chat.data[t].username_timeout},1500)},update_messages:function(){var t=Date.now();jQuery.post(quick_chat.ajaxurl,{action:"quick-chat-ajax-update-messages",last_timestamp:quick_chat.last_timestamp,rooms:quick_chat.rooms},function(t){if((0==quick_chat.no_participation&&1==t.no_participation||1==quick_chat.no_participation&&0==t.no_participation)&&location.reload(!0),1==t.success){var a=t.messages;jQuery("div.quick-chat-container").each(function(){for(var t=0,e=jQuery(this).attr("data-quick-chat-id"),i=quick_chat.data[e].room_name,c=quick_chat.data[e].avatars,u=quick_chat.data[e].scroll_enable,r=jQuery(this).find(".quick-chat-history-container"),s=quick_chat.data[e].state,_=0;"undefined"!=typeof a[_];_++)if(i==a[_].room)if("quick_chat"!=a[_].alias)0==t&&1==quick_chat.play_audio&&quick_chat.user_name!=quick_chat.stripslashes(a[_].alias)&&0!=quick_chat.last_timestamp&&(quick_chat.audio_element.play(),t=1),0!=quick_chat.last_timestamp&&"undefined"!=typeof s&&"m"==s&&jQuery(this).find("div.quick-chat-container-private-minimize-restore a").click(),jQuery(r).append(quick_chat.single_message_html(a[_],c,!1));else if(0!=quick_chat.last_timestamp){var n=jQuery.parseJSON(quick_chat.stripslashes(a[_].message));for(var o in n)if(n[o].private_to==quick_chat.user_name&&"INV"==n[o].type){if(quick_chat.is_private_allowed(a[_].status)){quick_chat.private_queue[o]=n[o],quick_chat.update_private_cookie(quick_chat.private_queue_name,quick_chat.private_queue);var h=jQuery.extend(!0,{},a[_]);h.message=quick_chat.i18n.invitation_received_s.replace("%s",n[o].private_from),jQuery(r).append(quick_chat.single_message_html(h,0,!0))}}else if(n[o].private_from==quick_chat.user_name){var k=!1;for(var q in quick_chat.private_queue)quick_chat.is_private_eq(quick_chat.private_queue[q],n[o])&&(quick_chat.spawn_private_chat(q,n[o].private_to,"o"),quick_chat.update_rooms(),delete quick_chat.private_queue[q],quick_chat.update_private_cookie(quick_chat.private_queue_name,quick_chat.private_queue),quick_chat.private_current[q]=quick_chat.data[q],quick_chat.update_private_cookie(quick_chat.private_current_name,quick_chat.private_current),k=!0);if(0==k)if(quick_chat.is_private_allowed(a[_].status)){quick_chat.spawn_private_chat(o,n[o].private_to,"o"),quick_chat.update_rooms(),quick_chat.private_current[o]=quick_chat.data[o],quick_chat.update_private_cookie(quick_chat.private_current_name,quick_chat.private_current);var p=jQuery.extend(!0,{},a[_]);p.message=quick_chat.i18n.invitation_sent_s.replace("%s",n[o].private_to),jQuery(r).append(quick_chat.single_message_html(p,0,!0))}else alert(quick_chat.i18n.not_allowed_to_initiate_s)}}1==u&&jQuery(r).animate({scrollTop:jQuery(r)[0].scrollHeight},500)}),quick_chat.last_timestamp=a[a.length-1].unix_timestamp}},"json").always(function(){if(!quick_chat.is_user_inactive()){var a=Math.max(0,1e3*quick_chat.timeout_refresh_messages-(Date.now()-t));setTimeout(function(){quick_chat.update_messages()},a)}})},update_users:function(){quick_chat.update_users_counter++,quick_chat.is_user_inactive()?(clearInterval(quick_chat.users_interval),jQuery("div.quick-chat-container").html('<div style="quick-chat-bootom-notice">'+quick_chat.i18n.dropped_inactivity_s+"</div>")):jQuery.post(quick_chat.ajaxurl,{action:"quick-chat-ajax-update-users",rooms:quick_chat.rooms},function(t){(0==quick_chat.no_participation&&1==t.no_participation||1==quick_chat.no_participation&&0==t.no_participation)&&location.reload(!0),"undefined"==typeof quick_chat.users_interval&&(quick_chat.users_interval=setInterval(function(){quick_chat.update_users()},1e3*quick_chat.timeout_refresh_users));var a=t.users;jQuery("div.quick-chat-container").each(function(){for(var t=jQuery(this).attr("data-quick-chat-id"),e=quick_chat.data[t].userlist_position,i=quick_chat.data[t].room_name,c="",u=0;"undefined"!=typeof a[u];u++)if(i==a[u].room){if(0==quick_chat.user_status){var r=[];jQuery(this).find(".quick-chat-users-container input[type=checkbox]:checked").each(function(){r.push(jQuery(this).attr("data-user-id"))})}var s=quick_chat.stripslashes(a[u].alias);c+='<div class="quick-chat-single-user '+quick_chat.user_status_class(a[u].status)+'">',s==quick_chat.user_name||1==quick_chat.no_participation?c+=s:(0==quick_chat.user_status&&(c+='<input class="quick-chat-to-ban-boxes" type="checkbox" name="quick-chat-to-ban[]" value="'+a[u].ip+'" data-user-id="'+a[u].id+'"'+(0==jQuery.inArray(a[u].id,r)?' checked="checked"':"")+"/>"),c+='<a href="" title="'+quick_chat.i18n.private_with_s.replace("%s",s)+'">'+s+"</a>"),c+=quick_chat.flag_html(a[u]),c+="</div>","top"==e&&(c+=", ")}jQuery(this).find(".quick-chat-users-container").html("top"==e?c.substring(0,c.length-2):c)})},"json")},new_message:function(t,a,e){var i=quick_chat.data[t].room_name;quick_chat.update_users_counter=0,jQuery.post(quick_chat.ajaxurl,{action:"quick-chat-ajax-new-message",sys_mes:e,message:a,room:i},function(t){0==quick_chat.no_participation&&1==t.no_participation&&location.reload(!0)})}});if(quick_chat.audio_element.canPlayType&&(quick_chat.audio_element.canPlayType('audio/ogg; codecs="vorbis"')?(quick_chat.audio_element.setAttribute("src",quick_chat.url+"/sounds/message-sound.ogg"),quick_chat.audio_element.setAttribute("preload","auto"),quick_chat.audio_support=1):quick_chat.audio_element.canPlayType("audio/mpeg;")?(quick_chat.audio_element.setAttribute("src",quick_chat.url+"sounds/message-sound.mp3"),quick_chat.audio_element.setAttribute("preload","auto"),quick_chat.audio_support=1):quick_chat.audio_element.canPlayType('audio/wav; codecs="1"')&&(quick_chat.audio_element.setAttribute("src",quick_chat.url+"sounds/message-sound.wav"),quick_chat.audio_element.setAttribute("preload","auto"),quick_chat.audio_support=1)),1==quick_chat.audio_support&&(jQuery.cookie("quick_chat_sound_state")?quick_chat.play_audio=jQuery.cookie("quick_chat_sound_state"):quick_chat.play_audio=quick_chat.audio_enable),0==quick_chat.no_participation){null!=jQuery.cookie(quick_chat.private_queue_name)&&(quick_chat.private_queue=jQuery.parseJSON(jQuery.cookie(quick_chat.private_queue_name))),null!=jQuery.cookie(quick_chat.private_current_name)&&(quick_chat.private_current=jQuery.parseJSON(jQuery.cookie(quick_chat.private_current_name)));for(var quick_chat_pc_room_name in quick_chat.private_current)quick_chat.spawn_private_chat(quick_chat_pc_room_name,quick_chat.private_current[quick_chat_pc_room_name].him,quick_chat.private_current[quick_chat_pc_room_name].state)}quick_chat.update_rooms(),quick_chat.audio_support&&(jQuery("div.quick-chat-sound-link").css("display","block"),quick_chat.update_sound_state()),quick_chat.update_users(),jQuery(document).on("keypress","textarea.quick-chat-message",function(t){if(code=t.keyCode?t.keyCode:t.which,13==code.toString()){t.preventDefault();var a=jQuery.trim(jQuery(this).val());if(""!=a){var e=jQuery(this).parents(".quick-chat-container").attr("data-quick-chat-id");jQuery(this).val(""),quick_chat.new_message(e,a,!1)}}}),jQuery("input.quick-chat-send-button").on("click",function(t){t.preventDefault();var a=jQuery(this).siblings("textarea.quick-chat-message"),e=jQuery.trim(jQuery(a).val());if(""!=e){var i=jQuery(this).parents(".quick-chat-container").attr("data-quick-chat-id");jQuery(a).val(""),quick_chat.new_message(i,e,!1)}jQuery(this).prev().focus()}),jQuery("div.quick-chat-smile").on("click",function(){var t=jQuery(this).parents(".quick-chat-container").find(".quick-chat-message"),a=jQuery(this);jQuery(this).fadeTo(100,0,function(){jQuery(t).quick_chat_insert_at_caret(jQuery(a).attr("title")).trigger("change"),jQuery(a).fadeTo(100,1)})}),jQuery(document).on("click","div.quick-chat-history-alias a",function(t){t.preventDefault();var a=jQuery(this).parents(".quick-chat-container").find(".quick-chat-message"),e=jQuery(this);jQuery(this).fadeTo(100,0,function(){jQuery(a).quick_chat_insert_at_caret("@"+jQuery(e).text()+": "),jQuery(e).fadeTo(100,1)})}),jQuery(document).on("click","div.quick-chat-single-user a",function(t){t.preventDefault();var a=jQuery(this).parents(".quick-chat-container").attr("data-quick-chat-id"),e=jQuery(this);jQuery(this).fadeTo(100,0,function(){var t=quick_chat.random_string(12),i=jQuery.parseJSON('{"'+t+'":{"private_from":"'+quick_chat.user_name+'","private_to":"'+jQuery(e).text()+'"}}'),c="INV",u=quick_chat.i18n.private_invite_confirm_s.replace("%s",jQuery(e).text());for(var r in quick_chat.private_queue){quick_chat.is_private_eq(quick_chat.private_queue[r],i[t])&&(c="ACK"),u=quick_chat.i18n.private_accept_confirm_s.replace("%s",jQuery(e).text());break}confirm(u)&&(i[t].type=c,quick_chat.new_message(a,jQuery.toJSON(i),!0)),jQuery(e).fadeTo(100,1)})}),jQuery(document).on("click","div.quick-chat-container-private-close a",function(t){t.preventDefault();var a=jQuery(this),e=jQuery(this).parents(".quick-chat-container").attr("data-quick-chat-id");jQuery(this).fadeTo(100,0,function(){delete quick_chat.data[e],delete quick_chat.private_current[e],quick_chat.update_private_cookie(quick_chat.private_current_name,quick_chat.private_current),quick_chat.private_count--,quick_chat.update_rooms(),jQuery(this).parents(".quick-chat-container").remove(),jQuery(a).fadeTo(100,1)})}),jQuery(document).on("click","div.quick-chat-container-private-minimize-restore a",function(t){t.preventDefault();var a=jQuery(this).parents(".quick-chat-container").attr("data-quick-chat-id"),e=jQuery(this).parents(".quick-chat-container"),i=quick_chat.data[a].state,c=jQuery(this);jQuery(this).fadeTo(100,0,function(){"o"==i?(jQuery(c).attr("title",quick_chat.private_restore),quick_chat.data[a].state="m",quick_chat.private_current[a].state="m",quick_chat.update_private_cookie(quick_chat.private_current_name,quick_chat.private_current),jQuery(c).text("o"),quick_chat.private_bottom_position(e,"m")):"m"==i&&(jQuery(c).attr("title",quick_chat.private_minimize),quick_chat.data[a].state="o",quick_chat.private_current[a].state="o",quick_chat.update_private_cookie(quick_chat.private_current_name,quick_chat.private_current),jQuery(c).text("-"),quick_chat.private_bottom_position(e,"o")),jQuery(c).fadeTo(100,1)})}),jQuery("div.quick-chat-sound-link a").on("click",function(t){t.preventDefault();var a=jQuery(this);jQuery(this).fadeTo(100,0,function(){1==quick_chat.play_audio?quick_chat.play_audio=0:quick_chat.play_audio=1,jQuery.cookie("quick_chat_sound_state",quick_chat.play_audio,{path:quick_chat.cookiepath,domain:quick_chat.cookie_domain}),quick_chat.update_sound_state(),jQuery(a).fadeTo(100,1)})}),jQuery("div.quick-chat-scroll-link a").on("click",function(t){t.preventDefault();var a=jQuery(this).parents(".quick-chat-container").attr("data-quick-chat-id"),e=quick_chat.data[a].scroll_enable,i=jQuery(this);jQuery(this).fadeTo(100,0,function(){0==e?(quick_chat.data[a].scroll_enable=1,jQuery(i).css("text-decoration","none")):(quick_chat.data[a].scroll_enable=0,jQuery(i).css("text-decoration","line-through")),jQuery(i).fadeTo(100,1)})}),(0==quick_chat.user_status||1==quick_chat.allow_change_username)&&jQuery("input.quick-chat-alias").on("keyup change",function(){var t=jQuery.trim(jQuery(this).val());if(""!=t){var a=jQuery(this).parents(".quick-chat-container").attr("data-quick-chat-id"),e=jQuery(this).parents(".quick-chat-container").find("span.quick-chat-username-status");quick_chat.check_username(a,t,e)}}),0!=quick_chat.user_status&&jQuery("textarea.quick-chat-message").on("keyup change input paste",function(){var t=jQuery(this).parents(".quick-chat-container").attr("data-quick-chat-counter");if(1==t){var a=jQuery(this).parents(".quick-chat-container").find("span.quick-chat-counter"),e=jQuery(this).val().length,i=quick_chat.message_maximum_number_chars-e;25>=i&&i>=0?jQuery(a).addClass("quick-chat-warning"):jQuery(a).removeClass("quick-chat-warning"),0>i?jQuery(a).addClass("quick-chat-exceeded"):jQuery(a).removeClass("quick-chat-exceeded"),jQuery(a).html(i)}}),quick_chat.update_messages();